<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUA 2026 Vision Survey</title>
    <style>
        /* ... (您的 CSS 樣式保持不變) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .survey-wrapper {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            animation: slideUp 0.6s ease forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        header {
            background: #007bff;
            color: white;
            padding: 25px 20px;
            text-align: center;
            border-bottom: 5px solid #0056b3;
            font-size: 1.8em;
            font-weight: 700;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            height: 8px;
            border-radius: 4px;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #28a745;
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
        }

        .survey-page {
            padding: 30px;
            display: none;
            flex-direction: column;
            gap: 25px;
            min-height: 500px; /* Ensure pages have a minimum height */
        }

        .survey-page.active {
            display: flex;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 1.1em;
        }

        .text-input,
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            color: #333;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .text-input:focus,
        select:focus,
        textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-btn {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
        }

        .nav-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #submitBtn {
            background-color: #28a745;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
        }

        #submitBtn:hover {
            background-color: #218838;
        }

        .committee-selection,
        .committee-feedback-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .committee-item {
            background-color: #f8f9fa;
            border: 1px solid #e2e6ea;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .committee-item:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
        }

        .committee-item.selected {
            background-color: #e0f7fa;
            border-color: #00bcd4;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.25);
        }

        .committee-item input[type="checkbox"] {
            margin-right: 8px;
            width: 20px;
            height: 20px;
            accent-color: #007bff;
            cursor: pointer;
        }

        .feedback-item {
            background-color: #f0f8ff; /* Light blue background */
            border: 1px solid #d0e8f8;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback-item label {
            font-weight: 700; /* Bolder labels for feedback sections */
            color: #0056b3; /* Darker blue color */
        }

        .feedback-item textarea {
            border-color: #a7d9f7; /* Lighter blue border */
        }

        .committee-feedback-title {
            background-color: #cfe2f3;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            color: #1a5e9a;
            margin-bottom: 15px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .survey-page {
                padding: 20px;
            }

            .nav-btn {
                padding: 10px 20px;
                font-size: 1em;
            }

            .committee-selection {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="survey-wrapper">
            <header>
                TUA 2026 Vision Survey
            </header>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div id="page1" class="survey-page active">
                <div class="form-group">
                    <label for="workplace">您的執業場所 (必填)</label>
                    <select id="workplace" class="text-input" required>
                        <option value="">請選擇</option>
                        <option value="醫學中心">醫學中心</option>
                        <option value="區域醫院">區域醫院</option>
                        <option value="地區醫院">地區醫院</option>
                        <option value="診所">診所</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="experience">您的執業年資 (必填)</label>
                    <select id="experience" class="text-input" required>
                        <option value="">請選擇</option>
                        <option value="0-5年">0-5年</option>
                        <option value="6-15年">6-15年</option>
                        <option value="16-25年">16-25年</option>
                        <option value="26年以上">26年以上</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userName">您的姓名 (選填 optional)</label>
                    <input type="text" id="userName" class="text-input" placeholder="請輸入您的姓名（選填）">
                </div>
                <div class="button-group">
                    <button class="nav-btn" onclick="nextPage()">下一頁</button>
                </div>
            </div>

            <div id="page2" class="survey-page">
                <div class="form-group">
                    <label>您最關注或希望提出建議的委員會 (可複選)</label>
                    <div class="committee-selection" id="committeeSelection">
                        </div>
                </div>
                <div class="button-group">
                    <button class="nav-btn" onclick="prevPage()">上一頁</button>
                    <button class="nav-btn" onclick="nextPage()" id="nextPage2Btn">下一頁</button>
                </div>
            </div>

            <div id="page3" class="survey-page">
                <label>請針對您選擇的委員會提供建議：</label>
                <div id="committeeFeedback" class="feedback-container">
                    </div>
                <div class="form-group">
                    <label for="crossDisciplinary">對於跨領域合作的綜合建議：</label>
                    <textarea id="crossDisciplinary" class="text-input" placeholder="您對於不同委員會之間或與其他醫療領域的合作有何建議？"></textarea>
                </div>
                <div class="form-group">
                    <label for="highlightPolicy">您認為未來 TUA 發展的亮點政見或願景是什麼？</label>
                    <textarea id="highlightPolicy" class="text-input" placeholder="請描述您心目中 TUA 未來最重要的方向或目標。"></textarea>
                </div>
                <div class="button-group">
                    <button class="nav-btn" onclick="prevPage()">上一頁</button>
                    <button class="nav-btn" id="submitBtn">☁️ 儲存至 Google Sheets</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        &copy; 2025 TUA. All rights reserved.
    </footer>

    <script>
        let currentPage = 1;
        const totalPages = 3;
        const progressBar = document.getElementById('progressBar');
        const submitButton = document.getElementById('submitBtn');

        // Committee data (ID and display name)
        const committees = [
            { id: 'academic-general', name: '學術性委員會(總體)' },
            { id: 'uro-oncology', name: '泌尿腫瘤委員會' },
            { id: 'robotic-laparoscopic', name: '機器手臂暨腹腔鏡手術委員會' },
            { id: 'functional-urology', name: '功能性泌尿學委員會' },
            { id: 'urolithiasis', name: '尿路結石委員會' },
            { id: 'infection-inflammation', name: '感染與發炎委員會' },
            { id: 'kidney-transplant', name: '腎臟移植委員會' },
            { id: 'pediatric-urology', name: '小兒泌尿學委員會' },
            { id: 'andrology', name: '男性學委員會' },
            { id: 'joint-research', name: '聯合研究委員會' },
            { id: 'administrative-general', name: '事務性委員會(總體)' },
            { id: 'international-affairs', name: '國際事務委員會' },
            { id: 'education', name: '教育委員會' },
            { id: 'insurance-self-pay', name: '健保及自費醫療委員會' },
            { id: 'journal', name: '學會雜誌委員會' },
            { id: 'training-accreditation', name: '訓練醫院評鑑委員會' },
            { id: 'specialist-review', name: '專科醫師甄審委員會' },
            { id: 'it-online-education', name: '資訊暨線上教育委員會' },
            { id: 'primary-care', name: '基層醫療委員會' },
            { id: 'innovation', name: '新創委員會' },
            { id: 'medical-policy-pr', name: '醫療政策暨公共關係委員會' },
            { id: 'young-urologists', name: '青年事務委員會' }
        ];

        // Function to update progress bar
        function updateProgressBar() {
            const progress = (currentPage / totalPages) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Function to show a specific page
        function showPage(pageNumber) {
            document.querySelectorAll('.survey-page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page${pageNumber}`).classList.add('active');
            currentPage = pageNumber;
            updateProgressBar();
            
            // If navigating to page 3, ensure committee feedback sections are generated
            if (pageNumber === 3) {
                generateCommitteeFeedbackSections();
            }
        }

        // Function to navigate to the next page
        function nextPage() {
            // Basic validation for page 1
            if (currentPage === 1) {
                const workplace = document.getElementById('workplace').value;
                const experience = document.getElementById('experience').value;
                if (!workplace || !experience) {
                    alert('請填寫所有必填欄位！');
                    return;
                }
            }
            // Basic validation for page 2 (at least one committee must be selected)
            if (currentPage === 2) {
                const selectedCheckboxes = document.querySelectorAll('#committeeSelection input[type="checkbox"]:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('請至少選擇一個委員會！');
                    return;
                }
            }

            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        }

        // Function to navigate to the previous page
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        }

        // Function to dynamically load committee selection options
        function loadCommitteeSelection() {
            const container = document.getElementById('committeeSelection');
            committees.forEach(committee => {
                const div = document.createElement('div');
                div.className = 'committee-item';
                div.innerHTML = `
                    <input type="checkbox" id="committee-${committee.id}" name="committee" value="${committee.id}">
                    <label for="committee-${committee.id}">${committee.name}</label>
                `;
                div.addEventListener('click', () => {
                    const checkbox = div.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    div.classList.toggle('selected', checkbox.checked);
                });
                // Ensure clicking checkbox itself also toggles selected class
                div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                    e.stopPropagation(); // Prevent click event on div from firing again
                    div.classList.toggle('selected', e.target.checked);
                });
                container.appendChild(div);
            });
        }

        // Function to dynamically generate feedback sections for selected committees
        function generateCommitteeFeedbackSections() {
            const feedbackContainer = document.getElementById('committeeFeedback');
            feedbackContainer.innerHTML = ''; // Clear previous sections

            const selectedCommittees = Array.from(document.querySelectorAll('#committeeSelection input[type="checkbox"]:checked'))
                                            .map(cb => committees.find(c => c.id === cb.value));
            
            selectedCommittees.forEach(committee => {
                const div = document.createElement('div');
                div.className = 'feedback-item';
                div.innerHTML = `
                    <div class="committee-feedback-title">${committee.name}</div>
                    <div class="form-group">
                        <label for="${committee.id}-challenges">現況挑戰與問題：</label>
                        <textarea id="${committee.id}-challenges" class="text-input" placeholder="請描述您認為該委員會目前面臨的挑戰與問題。"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="${committee.id}-future">未來方向與建議：</label>
                        <textarea id="${committee.id}-future" class="text-input" placeholder="請提供您對該委員會未來發展方向、目標或具體方案的建議。"></textarea>
                    </div>
                `;
                feedbackContainer.appendChild(div);
            });
        }

        // Collect all form data before submission
        function collectFormData() {
            const formData = {
                workplace: document.getElementById('workplace').value,
                experience: document.getElementById('experience').value,
                userName: document.getElementById('userName')?.value || '', // <--- IMPORTANT: Collect userName here
                selectedCommittees: Array.from(document.querySelectorAll('#committeeSelection input[type="checkbox"]:checked'))
                                         .map(cb => cb.value),
                crossDisciplinary: document.getElementById('crossDisciplinary').value,
                highlightPolicy: document.getElementById('highlightPolicy').value,
                committeeResponses: {}
            };

            // Collect committee-specific feedback
            formData.selectedCommittees.forEach(committeeId => {
                formData.committeeResponses[committeeId] = {
                    challenges: document.getElementById(`${committeeId}-challenges`)?.value || '',
                    future: document.getElementById(`${committeeId}-future`)?.value || ''
                };
            });

            return formData;
        }

        // Handle form submission
        submitButton.addEventListener('click', handleFormSubmit);

        function handleFormSubmit(event) {
            event.preventDefault(); // Prevent default form submission
            
            // Basic validation for Page 3
            // You can add more specific validation here if needed
            const crossDisciplinary = document.getElementById('crossDisciplinary').value;
            const highlightPolicy = document.getElementById('highlightPolicy').value;
            // No strict required for textareas, but can add if necessary
            // if (!crossDisciplinary || !highlightPolicy) {
            //     alert('請填寫所有必填的建議欄位！');
            //     return;
            // }

            submitButton.disabled = true;
            submitButton.textContent = '提交中...';

            const formData = collectFormData();

            // Prepare data for Google Apps Script using URLSearchParams
            // This format aligns with how Apps Script's e.parameter handles form-encoded data
            const params = new URLSearchParams();
            params.append('timestamp', new Date().toISOString());
            params.append('userName', formData.userName || ''); // <--- IMPORTANT: Add userName to params
            params.append('workplace', formData.workplace || '');
            params.append('experience', formData.experience || '');
            params.append('selectedCommittees', formData.selectedCommittees.join(';')); // Send as semicolon-separated string
            params.append('crossDisciplinary', formData.crossDisciplinary || '');
            params.append('highlightPolicy', formData.highlightPolicy || '');

            // Add committee-specific responses individually to URLSearchParams
            for (const committeeId in formData.committeeResponses) {
                const responses = formData.committeeResponses[committeeId];
                if (responses.challenges) {
                    params.append(`${committeeId}_challenges`, responses.challenges);
                }
                if (responses.future) {
                    params.append(`${committeeId}_future`, responses.future);
                }
            }
            
            // Your Google Apps Script Web App URL
            // Ensure this URL is correct and deployed as 'Execute as: Me' and 'Who has access: Anyone'
            // Please use the URL that Postman successfully used:
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-YvCfiL-xE50vOFzmT4zrO1Kv7McvtnzGF5zLTZtD2jkA21M2UB3NWBe4r_l-yXVbcQ/exec'; 

            // 發送資料到 Google Apps Script
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                // Change mode to 'cors' to allow proper header handling and error reporting
                mode: 'cors', // <--- IMPORTANT CHANGE: This requires Apps Script to send CORS headers
                // Set Content-Type header explicitly for URL-encoded data
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded', // <--- IMPORTANT CHANGE
                },
                body: params.toString() // <--- IMPORTANT CHANGE: Send URL-encoded string
            })
            .then(response => {
                // Check if response is OK (status 200-299)
                if (!response.ok) {
                    // If not OK, read error message from response body
                    // Apps Script often returns success/error messages in plain text
                    return response.text().then(text => { 
                        throw new Error(`HTTP error! status: ${response.status}. Message: ${text || 'Unknown error.'}`); 
                    });
                }
                return response.text(); // Read response as text
            })
            .then(data => {
                console.log('Success:', data);
                alert('資料已成功提交至 Google Sheets！');
                submitButton.textContent = '✓ 已提交';
                // Optional: Reset form or navigate
                // window.location.reload(); 
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('提交失敗，請稍後再試。' + error.message); // Show error message from throw
                submitButton.disabled = false;
                submitButton.textContent = '☁️ 儲存至 Google Sheets';
            });
        }

        // Initialize survey
        document.addEventListener('DOMContentLoaded', () => {
            loadCommitteeSelection();
            showPage(1); // Start on the first page
        });

    </script>
</body>
</html>
